var app = angular.module('app', ['ngResource','angular-jwt', 'angular-storage']);

app.config(function($interpolateProvider, $resourceProvider, $httpProvider){
	$resourceProvider.defaults.stripTrailingSlashes = false;

	$interpolateProvider.startSymbol('[[');
    $interpolateProvider.endSymbol(']]');

	$httpProvider.defaults.xsrfCookieName = 'csrftoken';
	$httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
});
// app.controller('Controller', function Controller(AuthService, $scope){
// 	var aToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6InByYWxsZW45MEBnbWFpbC5jb20iLCJleHAiOjE0Mzc0OTA2NzAsInVzZXJfaWQiOjEsInVzZXJuYW1lIjoicGF0In0.e-9HkIbd6Ul75YN80EaG83SrPuxy3Cxt2YPAteDP3HU';
// 	$scope.token = aToken;
// 	$scope.decodedToken = jwtHelper.decodeToken(aToken);
// 
// 	$scope.$watch('aToken', function(aToken){
// 		if(!aToken) return;
// 
// 		$scope.decodedToken = jwtHelper.decodeToken(aToken);
// 	});
// });

app.factory('AuthService', function($http, jwtHelper) {
	var self = this;
	self.user = {};
	
	return {
		setUser : function(token){
			var decodedToken = jwtHelper.decodeToken(token);	
			self.username = decodedToken.user.username;
			self.email = decodedToken.user.email;
		}
	}
});

app.controller('LoginCtrl', function LoginController($scope, $http, store, AuthService) {
	$scope.user = {};

	$scope.login = function() {
		$http({
			url: 'http://localhost:5000/api-token-auth/',
			method: 'POST',
			data: $scope.user
		})
		.then(function(response){
			AuthService.setUser(response.data.token);
			store.set('jwt', response.data.token);	
		}, function(error){
			alert(error.data);	
		});	
	}
});
